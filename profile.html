<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INFORMATION PROFILE</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
:root {
  --primary-color:#6c5ce7;
  --primary-hover:#5649d1;
  --card-bg:#fff;
  --border-radius:12px;
  --shadow:0 6px 16px rgba(0,0,0,0.12);
  --transition:all 0.25s ease;
  --success-color:#00b894;
  --error-color:#ff7675;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Outfit",sans-serif;min-height:100vh;background:linear-gradient(135deg,#ece9f2,#f5f6fa);display:flex;justify-content:center;align-items:center}
.profile-wrapper{width:95%;max-width:600px;padding:0.5rem;position:relative}
.card{background:var(--card-bg);border-radius:var(--border-radius);box-shadow:0 8px 24px rgba(0,0,0,0.25);overflow:hidden;border:1px solid rgba(108,92,231,0.15);position:relative;z-index:1}
.banner{width:100%;height:180px;background:linear-gradient(135deg,#6c5ce7,#5649d1);position:relative;cursor:pointer;overflow:hidden}
.banner-img{width:100%;height:100%;box-shadow:0 8px 24px rgba(0,0,0,0.25);object-fit:cover;display:block;transition:opacity 0.3s}
.banner::after{content:"\f044";font-family:"Font Awesome 6 Free";font-weight:900;position:absolute;top:10px;right:10px;color:#fff;background:rgba(0,0,0,0.45);padding:5px 8px;border-radius:6px;cursor:pointer;z-index:2}
.profile-pic{width:140px;height:140px;border-radius:12px;border:3px solid #fff;object-fit:cover;position:absolute;top:170px;left:50%;transform:translateX(-50%);background:#eee;z-index:10;box-shadow:0 4px 10px rgba(0,0,0,0.15)}
.card-content{padding:4.5rem 1.8rem 2rem;text-align:center}
h2{margin-bottom:1rem;color:var(--primary-color);font-size:1.8rem}
.profile-info{margin:1rem auto 1.8rem;max-width:480px;display:flex;flex-direction:column;gap:0.6rem}
.info-row{display:flex;align-items:center;gap:12px;background:rgba(108,92,231,0.05);padding:0.55rem 0.9rem;border-radius:8px;font-size:0.94rem;transition:background 0.25s}
.info-row:hover{background:rgba(108,92,231,0.12)}
.info-row i{font-size:1rem;color:var(--primary-color);flex-shrink:0;width:18px;text-align:center}
.info-label{font-weight:600;color:#2c3e50}
.info-value{flex:1;text-align:left;overflow-x:auto;user-select:text;padding:2px 4px}
.info-value.editable{max-width:60%;border:1px solid #ccc;border-radius:6px;padding:4px 8px;white-space:nowrap}
.info-value.editable:focus{border-color:var(--primary-color);outline:none}
.edit-btn{margin-left:auto;background:var(--primary-color);color:#fff;border:none;border-radius:6px;padding:5px 8px;cursor:pointer;font-size:0.85rem}
.edit-btn:hover{background:var(--primary-hover)}
.button-group{display:flex;flex-direction:column;gap:0.6rem}
button.main{width:100%;padding:0.85rem 0;border:none;border-radius:8px;background:var(--primary-color);color:#fff;font-weight:600;display:flex;align-items:center;justify-content:center;gap:0.4rem;cursor:pointer;transition:var(--transition)}
button.main:hover{background:var(--primary-hover);transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}
#toast-container{position:fixed;top:15px;left:50%;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;align-items:center}
.toast{margin-bottom:8px;padding:0.7rem 1.1rem;border-radius:8px;color:#fff;font-weight:500;font-size:0.92rem;box-shadow:var(--shadow)}
.toast.success{background:var(--success-color)}
.toast.error{background:var(--error-color)}
canvas#particle-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
@media(max-width:480px){
.card-content{padding:4rem 1.5rem 1.5rem}
h2{font-size:1.55rem}
.profile-pic{width:95px;height:95px;top:120px}
.info-row{font-size:0.88rem;padding:0.5rem 0.8rem}
button.main{padding:0.75rem 0}
}
</style>
</head>
<body>
<canvas id="particle-bg"></canvas>
<div class="profile-wrapper">
  <img class="profile-pic" id="profilePic" alt="Profile">
  <div class="card">
    <div class="banner" id="banner">
      <img class="banner-img" id="bannerImg" alt="Banner">
    </div>
    <div class="card-content">
      <h2>INFORMATION</h2>
      <div class="profile-info" id="profileInfo"></div>
      <div class="button-group">
        <button class="main" id="checkEndpointBtn"><i class="fa-solid fa-plug"></i> Cek Endpoint</button>
        <button class="main" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>
  </div>
</div>
<div id="toast-container"></div>
<script>
const canvas=document.getElementById("particle-bg"),ctx=canvas.getContext("2d");let particles=[];
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
window.addEventListener("resize",resizeCanvas);resizeCanvas();
function initParticles(c=120){particles=[];for(let i=0;i<c;i++){particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,radius:Math.random()*3+1,color:["#6c5ce7","#00b894","#ffeaa7","#fd79a8"][Math.floor(Math.random()*4)],speedX:(Math.random()-0.5)*0.6,speedY:(Math.random()-0.5)*0.6})}}
initParticles();
function drawParticles(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.radius,0,2*Math.PI);ctx.fillStyle=p.color;ctx.fill();p.x+=p.speedX;p.y+=p.speedY;if(p.x<0||p.x>canvas.width)p.speedX*=-1;if(p.y<0||p.y>canvas.height)p.speedY*=-1});requestAnimationFrame(drawParticles)}
drawParticles();

function showToast(type,msg){const c=document.getElementById("toast-container");if(!c)return;const t=document.createElement("div");t.className="toast "+type;t.textContent=msg;t.style.opacity=0;c.appendChild(t);requestAnimationFrame(()=>{t.style.transition="opacity 0.4s,transform 0.4s";t.style.opacity=1;t.style.transform="translateY(0)"});setTimeout(()=>{t.style.opacity=0;t.style.transform="translateY(-20px)";setTimeout(()=>t.remove(),400)},4000)}

async function sendEditToAPI(d){
  try{
    const r=await fetch("https://api.yydz.biz.id/api/user/edituser",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(d)
    });
    const res=await r.json();
    if(r.ok){
      showToast("success","✅ Update berhasil tersimpan di server!");
      await fetchAndRenderUser(d.apikey);
    }else{
      showToast("error","❌ Gagal: "+(res.message||"Server error"))
    }
  }catch(e){
    console.error(e);
    showToast("error","❌ Terjadi kesalahan saat mengirim ke server")
  }
}

async function fetchAndRenderUser(apikey){
  try{
    const r=await fetch("https://api.yydz.biz.id/api/user/getuserinfo?key="+encodeURIComponent(apikey));
    const res=await r.json();
    if(r.ok && res.data){
      localStorage.setItem("userData",JSON.stringify(res));
      renderUser(res.data);
    }else{
      showToast("error","❌ Gagal ambil data user dari server");
    }
  }catch(e){
    console.error(e);
    showToast("error","❌ Tidak bisa konek server");
  }
}

function formatExpire(expire) {
  if (!expire) return "-";
  const d = new Date(expire);
  if (isNaN(d)) return expire; // fallback kalau bukan timestamp valid
  return d.toLocaleString("id-ID", {
    day: "2-digit", month: "2-digit", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
}

function renderUser(user){
  const profilePic=document.getElementById("profilePic"),
        bannerImg=document.getElementById("bannerImg"),
        profileInfo=document.getElementById("profileInfo");

  if(profilePic) profilePic.src=user.profile||"https://cdn.yupra.my.id/yp/jh9sycv3.jpg";
  if(bannerImg) bannerImg.src=user.banner||"https://cdn.yupra.my.id/yp/m01x45f7.jpg";

  function createRow(icon,label,value,editable=false,id=""){
    return editable
      ? `<div class="info-row"><i class="${icon}"></i><span class="info-label">${label}:</span><input type="text" class="info-value editable" id="${id}" value="${value||''}"/><button class="edit-btn" data-target="${id}" title="Simpan"><i class="fa-solid fa-floppy-disk"></i></button></div>`
      : `<div class="info-row"><i class="${icon}"></i><span class="info-label">${label}:</span><span class="info-value">${value||"-"}</span></div>`;
  }

  profileInfo.innerHTML=`
    ${createRow("fa-solid fa-envelope","Email",user.email)}
    ${createRow("fa-solid fa-key","API Key",user.apikey,user.role==="Premium","apikeyInput")}
    ${createRow("fa-solid fa-gauge","Limit",user.limit)}
    ${createRow("fa-solid fa-clock","Expired",formatExpire(user.expire))}
    ${createRow("fa-solid fa-user-gear","Role",user.role)}
  `;

  // === sisanya biarkan sama ===
  document.querySelectorAll(".edit-btn").forEach(btn=>{
    btn.addEventListener("click",async()=>{
      const tid=btn.getAttribute("data-target"),
            input=document.getElementById(tid);
      if(!input)return;
      const newValue=input.value.trim();
      if(!newValue){showToast("error","❌ Nilai tidak boleh kosong!");return}
      const field=tid.replace("Input","");
      user[field]=newValue;
      localStorage.setItem("userData",JSON.stringify({data:user}));
      await sendEditToAPI({apikey:user.apikey,[field]:newValue,role:user.role});
    });
  });

  function handleImageEdit(el,prop){
    if(!el)return;
    el.addEventListener("click",async()=>{
      const url=prompt(`Masukkan URL ${prop}:`,el.src);
      if(url){
        el.src=url;user[prop]=url;
        localStorage.setItem("userData",JSON.stringify({data:user}));
        showToast("success",`✅ ${prop} diperbarui!`);
        await sendEditToAPI({apikey:user.apikey,[prop]:url,role:user.role});
      }
    });
  }
  handleImageEdit(profilePic,"profile");
  handleImageEdit(bannerImg,"banner");
}

document.addEventListener("DOMContentLoaded", () => {
  const savedUser = localStorage.getItem("userData");
  if (!savedUser) {
    showToast("error", "❌ Anda belum login!");
    setTimeout(() => window.location.href = "login.html", 1500);
    return;
  }

  let userData;
  try {
    userData = JSON.parse(savedUser);
  } catch (e) {
    console.error("❌ Error parsing userData:", e);
    localStorage.removeItem("userData");
    showToast("error", "❌ Data login korup, silakan login ulang!");
    setTimeout(() => window.location.href = "login.html", 1500);
    return;
  }

  const user = (userData?.data && Object.keys(userData.data).length > 0) ? userData.data : userData;

  renderUser(user);
  if (user?.apikey) {
    fetchAndRenderUser(user.apikey);
  } else {
    console.warn("⚠️ API key tidak ditemukan di user data");
  }

  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    localStorage.removeItem("userData");
    showToast("success", "✅ Logout berhasil!");
    setTimeout(() => window.location.href = "login.html", 1000);
  });

  document.getElementById("checkEndpointBtn")?.addEventListener("click", () => {
    window.location.href = "/doc/get";
  });
});
</script>
</body>
</html>